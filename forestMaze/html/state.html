<!DOCTYPE html>
<html>

<head>
  <title>The Forest - controls</title>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
  <meta content="utf-8" http-equiv="encoding" />
  <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png" />
  <link rel="manifest" href="favicon_io/site.webmanifest" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <style>
    input[type="number"] {
      min-width: 300px;
    }
  </style>
</head>

<body>
  <form id="form">
  </form>
  <button id="submit">Submit</button>
  <script type="module">
    import { getJson, postJson } from './lib/fetchJson.js';

    function createSelect(parentElement, key, values, value) {
      const select = document.createElement('select');
      select.id = key;
      parentElement.appendChild(select);
      let option = document.createElement('option');
      option.innerText = '--';
      option.disabled = true;
      select.appendChild(option);
      values.forEach((subValue, i) => {
        option = document.createElement('option');
        option.innerText = `${subValue.charAt(0).toUpperCase()}${subValue.substr(1)}`;
        option.value = `../${subValue}`;
        select.appendChild(option);
        if (value === option.value) {
          select.selectedIndex = i + 1;
        }
      });
      return select;
    }

    function createInput(parentElement, key, value) {
      const input = document.createElement('input');
      input.id = key;
      parentElement.appendChild(input);
      switch (typeof value) {
        case 'boolean':
          input.type = 'checkbox';
          input.checked = value;
          break;
        case 'number':
          input.type = 'number';
          input.min = '0';
          input.step = '1';
          // input.max = '21';
        case 'string':
        default:
          input.value = value;
          break;
      }
      return input;
    }

    function onSubmit() {
      const form = document.getElementById("form");
      const state = {};
      Array.prototype.forEach.call(form.elements, (input) => {
        const { parentElement } = input;
        const { key, type } = parentElement.dataset;
        let value;
        switch (type) {
          case 'array':
            value = Array.prototype.map.call(parentElement.querySelectorAll('input'), (input) => input.value);
            break;
          case 'boolean':
            value = input.checked;
            break;
          case 'number':
            value = parseInt(input.value, 10);
            break;
          case 'string':
          default:
            value = input.value;
            break;
        }
        state[key] = value;
      });
      postJson('./state', state);
    }

    function init(state) {
      const submitButton = document.getElementById("submit");
      submitButton.addEventListener('click', onSubmit);

      const form = document.getElementById("form");
      Object.entries(state).forEach(([key, value]) => {
        let row = document.createElement('div');
        row.dataset.key = key;
        row.dataset.type = Array.isArray(value) ? 'array' : typeof value;
        form.appendChild(row);
        const label = document.createElement('label');
        label.for = key;
        label.innerText = `${key.charAt(0).toUpperCase()}${key.substr(1)}:`;
        row.appendChild(label);
        if (key === 'path') {
          createSelect(row, key, ['hither', 'vermeillon'], value);
          return;
        } else if (Array.isArray(value)) {
          label.for = `${key}_0`;
          value.forEach((subValue, i) => {
            createInput(row, `${key}_${i}`, subValue);
          });
        } else {
          createInput(row, key, value);
        }
      });
    }

    getJson('./state').then(init);
  </script>
</body>

</html>
